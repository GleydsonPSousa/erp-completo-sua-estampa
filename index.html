<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CosturaTech ERP | Sistema de Gestão</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Scrollbar customizada */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Kanban Styles */
        .kanban-column { min-height: 400px; }
        .kanban-card.dragging { opacity: 0.5; transform: scale(0.95); }
        .kanban-column.drag-over { background-color: rgba(99, 102, 241, 0.1); border: 2px dashed #6366f1; }
        
        /* Ocultar views por padrão de forma estrita */
        .view-section:not(.active) { display: none !important; }
        .view-section.active { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-200 overflow-hidden h-screen flex">

    <!-- ==================== TELA DE LOGIN ==================== -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100 dark:bg-slate-900 transition-opacity">
        <div class="bg-white dark:bg-slate-800 p-6 sm:p-8 m-4 rounded-2xl shadow-xl w-full max-w-md border border-slate-200 dark:border-slate-700">
            <div class="flex justify-center mb-6 text-brand-600 dark:text-brand-500">
                <i class="ph ph-scissors text-5xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-center mb-2">CosturaTech ERP</h2>
            <p class="text-sm text-center text-slate-500 dark:text-slate-400 mb-8">Faça login para acessar o painel</p>
            
            <form id="form-login" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">E-mail</label>
                    <input type="email" id="login-email" value="admin@empresa.com" class="w-full px-4 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none transition" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Senha</label>
                    <input type="password" id="login-senha" value="admin123" class="w-full px-4 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none transition" required>
                </div>
                <button type="submit" id="btn-login-submit" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-medium py-2.5 rounded-lg transition shadow-md shadow-brand-500/30">
                    Entrar no Sistema
                </button>
                <p class="text-xs text-center text-slate-400 mt-4">Demo mode: Clique em Entrar direto.</p>
            </form>
        </div>
    </div>

    <!-- ==================== LAYOUT PRINCIPAL (Oculto até o login) ==================== -->
    <div id="main-app" class="hidden w-full h-full flex">
        
        <!-- SIDEBAR -->
        <aside class="w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col transition-transform duration-300 absolute md:relative z-40 h-full transform -translate-x-full md:translate-x-0" id="sidebar">
            <div class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center">
                    <i class="ph ph-scissors text-brand-600 dark:text-brand-500 text-2xl mr-2"></i>
                    <span class="font-bold text-lg tracking-tight">CosturaTech</span>
                </div>
                <button onclick="document.getElementById('sidebar').classList.add('-translate-x-full')" class="md:hidden text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            
            <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1" id="nav-menu">
                <!-- Links gerados via JS -->
            </nav>

            <div class="p-4 border-t border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold">A</div>
                    <div>
                        <p class="text-sm font-medium" id="user-name">Admin User</p>
                        <p class="text-xs text-slate-500" id="user-role">Administrador</p>
                    </div>
                </div>
                <button onclick="App.logout()" class="w-full flex items-center justify-center gap-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 py-2 rounded-lg transition">
                    <i class="ph ph-sign-out"></i> Sair
                </button>
            </div>
        </aside>

        <!-- CONTEÚDO PRINCIPAL -->
        <main class="flex-1 flex flex-col h-full min-w-0 bg-slate-50 dark:bg-slate-900">
            
            <!-- HEADER -->
            <header class="h-16 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-4 sm:px-6 z-30">
                <div class="flex items-center">
                    <button id="btn-menu" class="md:hidden text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 mr-4">
                        <i class="ph ph-list text-2xl"></i>
                    </button>
                    <h1 id="page-title" class="text-xl font-semibold">Dashboard</h1>
                </div>
                
                <div class="flex items-center gap-4">
                    <button onclick="App.sincronizarComPlanilha()" class="w-9 h-9 rounded-full bg-brand-50 dark:bg-brand-900/40 flex items-center justify-center text-brand-600 dark:text-brand-400 hover:bg-brand-100 dark:hover:bg-brand-900/80 transition" title="Sincronizar com a Planilha">
                        <i class="ph ph-arrows-clockwise text-lg"></i>
                    </button>
                    <button onclick="App.toggleTheme()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition">
                        <i class="ph ph-moon dark:hidden text-lg"></i>
                        <i class="ph ph-sun hidden dark:block text-lg"></i>
                    </button>
                </div>
            </header>

            <!-- ÁREA DE VIEWS -->
            <div class="flex-1 overflow-y-auto p-4 sm:p-6" id="views-container">
                
                <!-- VIEW: DASHBOARD -->
                <div id="view-dashboard" class="view-section active">
                    <!-- KPIs -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="dashboard-kpis">
                        <!-- Renderizado via JS -->
                    </div>
                </div>

                <!-- VIEW: ORDENS DE SERVIÇO (KANBAN) -->
                <div id="view-ordens" class="view-section h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-medium">Quadro de Produção</h2>
                        <button onclick="App.openModal('modal-os')" class="bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition shadow-sm">
                            <i class="ph ph-plus"></i> Nova OS
                        </button>
                    </div>
                    
                    <div class="flex-1 flex flex-col gap-6 overflow-y-auto pb-4 items-stretch px-1" id="kanban-board">
                        <!-- Colunas renderizadas via JS -->
                    </div>
                </div>

                <!-- VIEW GENÉRICA DE TABELAS (Clientes, Produtos, Estoque, Financeiro) -->
                <div id="view-table-layout" class="view-section h-full flex flex-col">
                    
                    <!-- Resumo Financeiro (Exclusivo da aba financeiro) -->
                    <div id="financeiro-summary" class="hidden grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-4 flex-shrink-0">
                        <!-- Renderizado via JS -->
                    </div>

                    <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col flex-1 min-h-0">
                        <!-- Toolbar -->
                        <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4">
                            <h3 id="table-custom-title" class="text-base sm:text-lg font-bold text-slate-800 dark:text-white flex items-center w-full xl:w-auto">
                                <!-- Título dinâmico -->
                            </h3>
                            <div class="flex flex-col sm:flex-row gap-3 w-full xl:w-auto">
                                <div class="relative w-full sm:w-64">
                                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                    <input type="text" id="table-search" placeholder="Buscar..." class="w-full pl-9 pr-4 py-2 text-sm rounded-lg border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-brand-500 outline-none">
                                </div>
                                <button id="btn-add-record" onclick="App.handleAdicionar()" class="w-full sm:w-auto bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition shadow-sm">
                                    <i class="ph ph-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>
                        <!-- Table Wrapper -->
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-slate-50 dark:bg-slate-900/50 text-slate-500 dark:text-slate-400 sticky top-0" id="table-head">
                                    <!-- Renderizado via JS -->
                                </thead>
                                <tbody class="divide-y divide-slate-200 dark:divide-slate-700" id="table-body">
                                    <!-- Renderizado via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- ==================== MODALS ==================== -->
    
    <!-- Backdrop genérico -->
    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 opacity-0 transition-opacity">
        
        <!-- Modal: Nova Ordem de Serviço -->
        <div id="modal-os" class="modal-content hidden bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95 transition-transform">
            <div class="p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold">Nova Ordem de Serviço</h3>
                <button onclick="App.closeModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-4 sm:p-5 overflow-y-auto flex-1 space-y-4">
                <input type="hidden" id="os-id" value="">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium mb-1">Cliente</label>
                        <select id="os-cliente" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Produto</label>
                        <select id="os-produto" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none" onchange="App.calcularOS()"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Quantidade</label>
                        <input type="number" id="os-quantidade" min="1" value="1" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none" onchange="App.calcularOS()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Preço Venda Un. (R$)</label>
                        <input type="number" id="os-preco-venda" step="0.01" placeholder="Calculado auto..." class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none" onchange="App.calcularOS()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Frete Adicional (R$)</label>
                        <input type="number" id="os-frete" step="0.01" value="0.00" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none" onchange="App.calcularOS()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Data Entrega</label>
                        <input type="date" id="os-data" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none dark:[color-scheme:dark]">
                    </div>
                </div>
                
                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg border border-slate-200 dark:border-slate-700 mt-4 space-y-2">
                    <h4 class="font-medium text-sm text-slate-500 dark:text-slate-400 mb-2">Resumo Financeiro e Produção</h4>
                    <div class="flex justify-between text-sm"><span class="text-slate-500">Custo Total Previsto:</span> <span id="res-custo" class="font-medium">R$ 0,00</span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-500">Tecido Necessário:</span> <span id="res-tecido" class="font-medium text-amber-600">0.00m</span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-500">Valor Venda Unitário:</span> <span id="res-unitario" class="font-medium">R$ 0,00</span></div>
                    <div class="border-t border-slate-200 dark:border-slate-700 my-2 pt-2 flex justify-between">
                        <span class="font-bold">Valor Total a Cobrar:</span> <span id="res-total" class="font-bold text-brand-600 dark:text-brand-400 text-lg">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between text-sm"><span class="text-slate-500">Lucro Estimado:</span> <span id="res-lucro" class="font-bold text-emerald-600">R$ 0,00</span></div>
                </div>
            </div>
            <div class="p-4 sm:p-5 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3 bg-slate-50 dark:bg-slate-800/50">
                <button onclick="App.closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 rounded-lg transition">Cancelar</button>
                <button onclick="App.salvarOS()" class="px-4 py-2 text-sm font-medium bg-brand-600 hover:bg-brand-700 text-white rounded-lg transition">Salvar Ordem</button>
            </div>
        </div>

        <!-- Modal: Novo Cliente -->
        <div id="modal-cliente" class="modal-content hidden bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95 transition-transform">
            <div class="p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold">Novo Cliente</h3>
                <button onclick="App.closeModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-4 sm:p-5 overflow-y-auto flex-1 space-y-4">
                <input type="hidden" id="cli-id" value="">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">Nome / Razão Social <span class="text-red-500">*</span></label>
                        <input type="text" id="cli-nome" placeholder="Ex: Confecções Silva" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">CPF / CNPJ</label>
                        <input type="text" id="cli-cpf-cnpj" placeholder="000.000.000-00" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Telefone</label>
                        <input type="text" id="cli-telefone" placeholder="(00) 00000-0000" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">E-mail</label>
                        <input type="email" id="cli-email" placeholder="contato@empresa.com" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">Endereço Completo</label>
                        <input type="text" id="cli-endereco" placeholder="Rua Exemplo, 123 - Bairro" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cidade</label>
                        <input type="text" id="cli-cidade" placeholder="São Paulo" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Estado (UF)</label>
                        <input type="text" id="cli-estado" maxlength="2" placeholder="SP" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none uppercase">
                    </div>
                </div>
            </div>
            <div class="p-4 sm:p-5 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3 bg-slate-50 dark:bg-slate-800/50">
                <button onclick="App.closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 rounded-lg transition">Cancelar</button>
                <button onclick="App.salvarCliente()" class="px-4 py-2 text-sm font-medium bg-brand-600 hover:bg-brand-700 text-white rounded-lg transition">Salvar Cliente</button>
            </div>
        </div>

        <!-- Modal: Novo Produto -->
        <div id="modal-produto" class="modal-content hidden bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95 transition-transform">
            <div class="p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold">Produto / Modelagem</h3>
                <button onclick="App.closeModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-4 sm:p-5 overflow-y-auto flex-1 space-y-4">
                <input type="hidden" id="prod-id" value="">
                
                <h4 class="font-medium text-brand-600 dark:text-brand-400 border-b border-slate-100 dark:border-slate-700 pb-2">Detalhes do Produto</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Estilo / Modelo <span class="text-red-500">*</span></label>
                        <input type="text" id="prod-modelo" placeholder="Ex: Baby Look, Tradicional" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Tipo de Malha <span class="text-red-500">*</span></label>
                        <input type="text" id="prod-tecido" placeholder="Ex: Algodão 30.1" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Tamanho</label>
                        <input type="text" id="prod-tamanho" placeholder="Ex: M" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                </div>

                <h4 class="font-medium text-brand-600 dark:text-brand-400 border-b border-slate-100 dark:border-slate-700 pb-2 mt-4">Metragem e Custos Base</h4>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Altura (cm)</label>
                        <input type="number" id="prod-altura" placeholder="0" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Largura (cm)</label>
                        <input type="number" id="prod-largura" placeholder="0" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" title="Usado para baixa no estoque">Consumo Tecido (m)</label>
                        <input type="number" id="prod-consumo" step="0.01" placeholder="0.8" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Custo Tecido/m (R$)</label>
                        <input type="number" id="prod-custo-metro" step="0.01" placeholder="0.00" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Custo Estampa (R$)</label>
                        <input type="number" id="prod-custo-estampa" step="0.01" placeholder="0.00" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Mão de Obra (R$)</label>
                        <input type="number" id="prod-mao-obra" step="0.01" placeholder="0.00" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                </div>
                <p class="text-xs text-slate-500 mt-2">* O Preço de Venda Final será inserido na criação da Ordem de Serviço.</p>
            </div>
            <div class="p-4 sm:p-5 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3 bg-slate-50 dark:bg-slate-800/50">
                <button onclick="App.closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 rounded-lg transition">Cancelar</button>
                <button onclick="App.salvarProduto()" class="px-4 py-2 text-sm font-medium bg-brand-600 hover:bg-brand-700 text-white rounded-lg transition">Salvar Produto</button>
            </div>
        </div>

        <!-- Modal: Novo Lançamento Financeiro -->
        <div id="modal-financeiro" class="modal-content hidden bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95 transition-transform">
            <div class="p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold">Lançamento Financeiro</h3>
                <button onclick="App.closeModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-4 sm:p-5 overflow-y-auto flex-1 space-y-4">
                <input type="hidden" id="fin-id" value="">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Tipo <span class="text-red-500">*</span></label>
                        <select id="fin-tipo" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none font-medium">
                            <option value="receita" class="text-emerald-600">Entrada (Receita)</option>
                            <option value="despesa" class="text-red-600">Saída (Despesa)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Conta / Banco <span class="text-red-500">*</span></label>
                        <select id="fin-conta" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                            <option value="Dinheiro em Espécie">Dinheiro em Espécie</option>
                            <option value="Banco Itaú">Banco Itaú</option>
                            <option value="Banco Nubank">Banco Nubank</option>
                            <option value="Banco Bradesco">Banco Bradesco</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium mb-1">Descrição <span class="text-red-500">*</span></label>
                        <input type="text" id="fin-descricao" placeholder="Ex: Pagamento Fornecedor X" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Categoria <span class="text-red-500">*</span></label>
                        <select id="fin-categoria" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                            <option value="Vendas">Vendas</option>
                            <option value="Insumos">Insumos (Tecidos, Linhas)</option>
                            <option value="Salários">Salários / Mão de Obra</option>
                            <option value="Impostos">Impostos</option>
                            <option value="Aluguel/Fixos">Aluguel e Custos Fixos</option>
                            <option value="Manutenção">Manutenção de Máquinas</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Valor Total (R$) <span class="text-red-500">*</span></label>
                        <input type="number" id="fin-valor" step="0.01" placeholder="0.00" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Data <span class="text-red-500">*</span></label>
                        <input type="date" id="fin-data" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none dark:[color-scheme:dark]">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Status <span class="text-red-500">*</span></label>
                        <select id="fin-status" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                            <option value="pago">Pago / Recebido</option>
                            <option value="pendente">Pendente</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Qtd. Parcelas <span class="text-xs text-slate-400 dark:text-slate-500">(1 = à vista)</span></label>
                        <input type="number" id="fin-parcelas" min="1" value="1" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                </div>
            </div>
            <div class="p-4 sm:p-5 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3 bg-slate-50 dark:bg-slate-800/50">
                <button onclick="App.closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 rounded-lg transition">Cancelar</button>
                <button onclick="App.salvarFinanceiro()" class="px-4 py-2 text-sm font-medium bg-brand-600 hover:bg-brand-700 text-white rounded-lg transition">Salvar Lançamento</button>
            </div>
        </div>

        <!-- Modal: Novo Estoque -->
        <div id="modal-estoque" class="modal-content hidden bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95 transition-transform">
            <div class="p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold">Material / Estoque</h3>
                <button onclick="App.closeModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-4 sm:p-5 overflow-y-auto flex-1 space-y-4">
                <input type="hidden" id="est-id" value="">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium mb-1">Nome do Material / Tecido <span class="text-red-500">*</span></label>
                        <input type="text" id="est-tecido" placeholder="Ex: Algodão 30.1" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Metragem Atual (m) <span class="text-red-500">*</span></label>
                        <input type="number" id="est-metragem" step="0.01" placeholder="0.00" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Custo Médio/m (R$) <span class="text-red-500">*</span></label>
                        <input type="number" id="est-custo" step="0.01" placeholder="0.00" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Estoque Mínimo (m) <span class="text-red-500">*</span></label>
                        <input type="number" id="est-minimo" step="0.01" placeholder="0.00" class="w-full px-3 py-2 rounded-lg border dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                </div>
            </div>
            <div class="p-4 sm:p-5 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3 bg-slate-50 dark:bg-slate-800/50">
                <button onclick="App.closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 rounded-lg transition">Cancelar</button>
                <button onclick="App.salvarEstoque()" class="px-4 py-2 text-sm font-medium bg-brand-600 hover:bg-brand-700 text-white rounded-lg transition">Salvar Material</button>
            </div>
        </div>

        <!-- Modal: Mensagem do Sistema -->
        <div id="modal-alert" class="modal-content hidden bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm p-6 text-center transform scale-95 transition-transform">
            <div id="alert-icon" class="mb-4 text-brand-500 flex justify-center"><i class="ph ph-info text-5xl"></i></div>
            <h3 id="alert-title" class="text-lg font-bold mb-2">Mensagem</h3>
            <p id="alert-message" class="text-slate-500 dark:text-slate-400 text-sm mb-6">Operação realizada com sucesso.</p>
            <button onclick="App.closeModal()" class="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-medium py-2 rounded-lg transition">OK</button>
        </div>

    </div>

    <!-- ==================== JAVASCRIPT PRINCIPAL ==================== -->
    <script>
        /**
         * CONFIGURAÇÃO DA API DO GOOGLE SHEETS
         * Para integrar com sua planilha real, cole a URL do Web App do Apps Script abaixo.
         * Se estiver vazio, o sistema usará o MOCK_DATA local para demonstração.
         */
        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycbzpOjlOhVgofAfS54f3nPZEpOVHJ1pceq2Djzaztf8gUWpIzuSYF7dXsuOm0QF-XZDtTg/exec" // Ex: "https://script.google.com/macros/s/SEU_ID/exec"
        };

        // --- DADOS MOCKADOS (Banco de Dados Local Inicial) ---
        const MOCK_DATA = {
            configuracoes: { custo_fixo_mensal: 3500, meta_producao_mensal: 500 },
            clientes: [
                { id: "C001", nome: "Escola Aprender", telefone: "(11) 9999-0000", email: "contato@aprender.com", cidade: "São Paulo", estado: "SP" },
                { id: "C002", nome: "Restaurante Sabor", telefone: "(11) 8888-1111", email: "compras@sabor.com", cidade: "Campinas", estado: "SP" }
            ],
            produtos: [
                { id: "P001", tipo: "Confecção", modelo: "Gola Careca", tecido: "Algodão 30.1", tamanho: "M", consumo_metro: 0.8, custo_metro: 25.0, custo_estampa: 5.0, mao_obra: 10.0, margem: 0 },
                { id: "P002", tipo: "Confecção", modelo: "Com Bolso", tecido: "Oxford", tamanho: "U", consumo_metro: 1.2, custo_metro: 15.0, custo_estampa: 8.0, mao_obra: 12.0, margem: 0 }
            ],
            estoque: [
                { id: "E001", tecido: "Algodão 30.1", metragem_atual: 150.5, custo_medio: 25.0, estoque_minimo: 50 },
                { id: "E002", tecido: "Oxford", metragem_atual: 40.0, custo_medio: 15.0, estoque_minimo: 100 }
            ],
            ordens: [
                { id: "OS-1001", cliente_id: "C001", produto_id: "P001", quantidade: 50, status: "corte", data_inicio: "2026-02-20", data_entrega: "2026-03-01", valor_total: 4400, lucro: 2640 },
                { id: "OS-1002", cliente_id: "C002", produto_id: "P002", quantidade: 20, status: "estampa", data_inicio: "2026-02-21", data_entrega: "2026-02-28", valor_total: 1804, lucro: 984 }
            ],
            financeiro: [
                { id: "F001", tipo: "receita", descricao: "Sinal OS-1001", categoria: "Vendas", conta: "Banco Itaú", valor: 2200, data: "2026-02-20", status: "pago" },
                { id: "F002", tipo: "despesa", descricao: "Compra Linhas", categoria: "Insumos", conta: "Dinheiro em Espécie", valor: 150, data: "2026-02-21", status: "pago" }
            ]
        };

        // Estado Global da Aplicação
        const State = {
            user: null,
            currentView: 'dashboard',
            data: JSON.parse(localStorage.getItem('erp_data')) || JSON.parse(JSON.stringify(MOCK_DATA)),
            charts: {}
        };

        // Definição do Menu e Tabelas
        const MENU = [
            { id: 'dashboard', icon: 'ph-squares-four', label: 'Dashboard' },
            { id: 'ordens', icon: 'ph-kanban', label: 'Produção (OS)' },
            { id: 'clientes', icon: 'ph-users', label: 'Clientes' },
            { id: 'produtos', icon: 'ph-t-shirt', label: 'Produtos' },
            { id: 'estoque', icon: 'ph-package', label: 'Estoque' },
            { id: 'financeiro', icon: 'ph-currency-dollar', label: 'Financeiro' }
        ];

        const TABLE_CONFIGS = {
            clientes: { headers: ['ID', 'Nome', 'Telefone', 'Email', 'Cidade/UF', 'Ações'], fields: ['id', 'nome', 'telefone', 'email', row => `${row.cidade}/${row.estado}`, row => `<button onclick="App.editarCliente('${row.id}')" class="text-brand-600 dark:text-brand-400 hover:text-brand-800 dark:hover:text-brand-300 transition mr-2" title="Editar"><i class="ph ph-pencil-simple text-lg"></i></button><button onclick="App.excluirCliente('${row.id}')" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 transition" title="Excluir"><i class="ph ph-trash text-lg"></i></button>`] },
            produtos: { headers: ['ID', 'Estilo/Modelo', 'Malha', 'Tamanho', 'Medidas', 'Ações'], fields: ['id', 'modelo', 'tecido', row => row.tamanho || '-', row => (row.altura && row.largura) ? `${row.altura}x${row.largura}cm` : '-', row => `<button onclick="App.editarProduto('${row.id}')" class="text-brand-600 dark:text-brand-400 hover:text-brand-800 dark:hover:text-brand-300 transition mr-2" title="Editar"><i class="ph ph-pencil-simple text-lg"></i></button><button onclick="App.excluirProduto('${row.id}')" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 transition" title="Excluir"><i class="ph ph-trash text-lg"></i></button>`] },
            estoque: { headers: ['ID', 'Tecido', 'Metragem (m)', 'Custo Médio', 'Status', 'Ações'], fields: ['id', 'tecido', 'metragem_atual', row => `R$ ${row.custo_medio.toFixed(2)}`, row => row.metragem_atual <= row.estoque_minimo ? `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">BAIXO</span>` : `<span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs font-bold">OK</span>`, row => `<button onclick="App.editarEstoque('${row.id}')" class="text-brand-600 dark:text-brand-400 hover:text-brand-800 dark:hover:text-brand-300 transition mr-2" title="Editar"><i class="ph ph-pencil-simple text-lg"></i></button><button onclick="App.excluirEstoque('${row.id}')" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 transition" title="Excluir"><i class="ph ph-trash text-lg"></i></button>`] },
            financeiro: { headers: ['ID', 'Tipo', 'Data', 'Descrição', 'Categoria', 'Conta', 'Valor', 'Status', 'Ações'], fields: ['id', row => row.tipo === 'receita' ? '<span class="text-emerald-500 font-medium"><i class="ph ph-arrow-up-right"></i> Entrada</span>' : '<span class="text-red-500 font-medium"><i class="ph ph-arrow-down-left"></i> Saída</span>', row => new Date(row.data).toLocaleDateString('pt-BR'), 'descricao', row => row.categoria || '-', row => row.conta || '-', row => `<span class="font-medium">R$ ${row.valor.toFixed(2)}</span>`, row => row.status === 'pago' ? '<span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs font-bold">PAGO</span>' : '<span class="bg-amber-100 text-amber-700 px-2 py-1 rounded text-xs font-bold">PENDENTE</span>', row => `<button onclick="App.editarFinanceiro('${row.id}')" class="text-brand-600 dark:text-brand-400 hover:text-brand-800 dark:hover:text-brand-300 transition mr-2" title="Editar"><i class="ph ph-pencil-simple text-lg"></i></button><button onclick="App.excluirFinanceiro('${row.id}')" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 transition" title="Excluir"><i class="ph ph-trash text-lg"></i></button>`] }
        };

        const KANBAN_STATUS = [
            { id: 'orcamento', label: 'Orçamento', color: 'bg-slate-200 dark:bg-slate-700' },
            { id: 'corte', label: 'Corte', color: 'bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300' },
            { id: 'estampa', label: 'Estampa / Bordado', color: 'bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300' },
            { id: 'costura', label: 'Costura', color: 'bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300' },
            { id: 'finalizado', label: 'Finalizado', color: 'bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300' },
            { id: 'entregue', label: 'Entregue', color: 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300' }
        ];

        // Core App Logic
        const App = {
            init() {
                this.setupListeners();
                this.checkAuth();
            },

            setupListeners() {
                document.getElementById('form-login').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });
                document.getElementById('btn-menu').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('-translate-x-full');
                });
                document.getElementById('table-search').addEventListener('input', (e) => this.renderCurrentTable(e.target.value));
            },

            checkAuth() {
                if (localStorage.getItem('erp_auth') === 'true') {
                    this.showMainApp();
                }
            },

            async login() {
                const email = document.getElementById('login-email').value;
                const senha = document.getElementById('login-senha').value;
                const submitBtn = document.getElementById('btn-login-submit');

                if (CONFIG.API_URL) {
                    try {
                        submitBtn.textContent = 'Aguarde...';
                        submitBtn.disabled = true;

                        const msgUint8 = new TextEncoder().encode(senha);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const senhaHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                        const response = await fetch(CONFIG.API_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'login',
                                payload: { email: email, senhaHash: senhaHash }
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            localStorage.setItem('erp_auth', 'true');
                            State.user = result.data;
                            if(result.data && result.data.nome) {
                                document.getElementById('user-name').textContent = result.data.nome;
                            }
                            if(result.data && result.data.perfil) {
                                document.getElementById('user-role').textContent = result.data.perfil;
                            }
                            this.showMainApp();
                            this.sincronizarComPlanilha();
                        } else {
                            this.showAlert('Acesso Negado', result.message || 'Credenciais inválidas.', true);
                        }
                    } catch (error) {
                        this.showAlert('Erro de Conexão', 'Não foi possível conectar à planilha.', true);
                    } finally {
                        submitBtn.textContent = 'Entrar no Sistema';
                        submitBtn.disabled = false;
                    }
                } else {
                    // Simulação de login (No real, chamaria API com fetch post)
                    localStorage.setItem('erp_auth', 'true');
                    this.showMainApp();
                }
            },

            async logout() {
                if (CONFIG.API_URL && localStorage.getItem('erp_auth') === 'true') {
                    try {
                        document.getElementById('user-name').textContent = "Salvando...";
                        await fetch(CONFIG.API_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'syncData', payload: State.data })
                        });
                    } catch (error) {
                        console.error('Erro ao sincronizar no logout:', error);
                    }
                }

                localStorage.removeItem('erp_auth');
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('login-screen').classList.add('flex');
                document.getElementById('user-name').textContent = "Admin User";
            },

            async sincronizarComPlanilha() {
                if (!CONFIG.API_URL) {
                    this.showAlert('Aviso', 'A URL da API (Planilha) não está configurada.', false);
                    return;
                }
                
                try {
                    const response = await fetch(CONFIG.API_URL + '?action=getDadosCompletos');
                    const result = await response.json();
                    
                    if (result.status === 'success' && result.data) {
                        // Atualiza o estado e localStorage
                        State.data = result.data;
                        localStorage.setItem('erp_data', JSON.stringify(State.data));
                        
                        // Recarrega a view atual
                        if(State.currentView === 'dashboard') {
                            this.renderDashboard();
                        } else if(State.currentView === 'ordens') {
                            this.renderKanban();
                        } else {
                            this.renderCurrentTable();
                        }
                        
                        this.showAlert('Sucesso', 'Dados sincronizados com sucesso a partir da planilha.');
                    } else {
                        this.showAlert('Erro', result.message || 'Falha ao obter os dados atualizados.', true);
                    }
                } catch (error) {
                    this.showAlert('Erro de Conexão', 'Não foi possível baixar os dados da planilha.', true);
                }
            },

            showMainApp() {
                document.getElementById('login-screen').classList.remove('flex');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                this.buildMenu();
                this.navigate('dashboard');
            },

            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                // Re-render charts for theme compatibility
                if(State.currentView === 'dashboard') this.renderDashboard();
            },

            buildMenu() {
                const nav = document.getElementById('nav-menu');
                nav.innerHTML = MENU.map(item => `
                    <button onclick="App.navigate('${item.id}')" id="nav-${item.id}" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700/50">
                        <i class="ph ${item.icon} text-lg"></i> ${item.label}
                    </button>
                `).join('');
            },

            navigate(viewId) {
                State.currentView = viewId;
                
                // Update Menu active state
                MENU.forEach(item => {
                    const btn = document.getElementById(`nav-${item.id}`);
                    btn.classList.remove('bg-brand-50', 'dark:bg-brand-900/20', 'text-brand-600', 'dark:text-brand-400');
                    if(item.id === viewId) {
                        btn.classList.add('bg-brand-50', 'dark:bg-brand-900/20', 'text-brand-600', 'dark:text-brand-400');
                    }
                });

                // Update Header
                const viewTitle = MENU.find(m => m.id === viewId).label;
                document.getElementById('page-title').textContent = viewTitle;

                // Hide all views
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                
                // Mobile close sidebar
                if(window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                }

                // Show specific view
                if(viewId === 'dashboard') {
                    document.getElementById('view-dashboard').classList.add('active');
                    this.renderDashboard();
                } else if(viewId === 'ordens') {
                    document.getElementById('view-ordens').classList.add('active');
                    this.renderKanban();
                } else {
                    document.getElementById('view-table-layout').classList.add('active');
                    this.renderCurrentTable();
                }
            },

            // ================= LÓGICA DE NEGÓCIO E CÁLCULOS =================
            
            calcRateioFixo() {
                const conf = State.data.configuracoes;
                return conf.custo_fixo_mensal / conf.meta_producao_mensal;
            },

            calcCustoProduto(produto) {
                const rateio = this.calcRateioFixo();
                const custo_total = (produto.consumo_metro * produto.custo_metro) + produto.custo_estampa + produto.mao_obra + rateio;
                const preco_venda = custo_total + (custo_total * (produto.margem / 100));
                return { custo: custo_total, preco: preco_venda };
            },

            // ================= RENDERIZADORES =================

            renderDashboard() {
                const ordens = State.data.ordens;
                const fin = State.data.financeiro;

                // KPIs
                const faturamento = fin.filter(f => f.tipo === 'receita').reduce((acc, curr) => acc + curr.valor, 0);
                const despesas = fin.filter(f => f.tipo === 'despesa').reduce((acc, curr) => acc + curr.valor, 0);
                const lucro = faturamento - despesas;
                const emProducao = ordens.filter(o => !['finalizado', 'entregue'].includes(o.status)).length;

                document.getElementById('dashboard-kpis').innerHTML = `
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
                        <div><p class="text-sm text-slate-500 mb-1">Faturamento Mês</p><h3 class="text-2xl font-bold text-slate-800 dark:text-white">R$ ${faturamento.toFixed(2)}</h3></div>
                        <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl"><i class="ph ph-trend-up"></i></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
                        <div><p class="text-sm text-slate-500 mb-1">Lucro Líquido</p><h3 class="text-2xl font-bold text-slate-800 dark:text-white">R$ ${lucro.toFixed(2)}</h3></div>
                        <div class="w-12 h-12 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-xl"><i class="ph ph-wallet"></i></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
                        <div><p class="text-sm text-slate-500 mb-1">Despesas Mês</p><h3 class="text-2xl font-bold text-slate-800 dark:text-white">R$ ${despesas.toFixed(2)}</h3></div>
                        <div class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-xl"><i class="ph ph-trend-down"></i></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
                        <div><p class="text-sm text-slate-500 mb-1">OS em Produção</p><h3 class="text-2xl font-bold text-slate-800 dark:text-white">${emProducao}</h3></div>
                        <div class="w-12 h-12 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center text-xl"><i class="ph ph-factory"></i></div>
                    </div>
                `;
            },

            renderCurrentTable(filterText = '') {
                const conf = TABLE_CONFIGS[State.currentView];
                if(!conf) return;

                // Controle de exibição do sumário financeiro
                const finSummary = document.getElementById('financeiro-summary');
                if (State.currentView === 'financeiro') {
                    if (finSummary) {
                        finSummary.classList.remove('hidden');
                        finSummary.classList.add('grid');
                        this.renderFinanceiroSummary();
                    }
                } else {
                    if (finSummary) {
                        finSummary.classList.add('hidden');
                        finSummary.classList.remove('grid');
                    }
                }
                
                // Atualiza o título da tabela dinamicamente
                const titleEl = document.getElementById('table-custom-title');
                if (titleEl) {
                    if (State.currentView === 'financeiro') {
                        titleEl.innerHTML = '<i class="ph ph-list-dashes mr-2 text-xl text-brand-500"></i> Registros Detalhados (Entradas e Saídas - 30 Dias)';
                    } else {
                        const viewLabel = MENU.find(m => m.id === State.currentView)?.label || 'Registros';
                        titleEl.innerHTML = `<i class="ph ph-table mr-2 text-xl text-brand-500"></i> Lista de ${viewLabel}`;
                    }
                }

                let data = State.data[State.currentView] || [];
                
                if (State.currentView === 'financeiro') {
                    const trintaDiasAtras = new Date();
                    trintaDiasAtras.setDate(trintaDiasAtras.getDate() - 30);
                    // Zera as horas para comparar apenas a data
                    trintaDiasAtras.setHours(0, 0, 0, 0);
                    
                    data = data.filter(row => {
                        if (!row.data) return true;
                        const dataLancamento = new Date(row.data + 'T00:00:00');
                        return dataLancamento >= trintaDiasAtras;
                    });
                    
                    // Ordenar por data decrescente (mais recente primeiro)
                    data.sort((a, b) => new Date(b.data || 0) - new Date(a.data || 0));
                }
                
                if(filterText) {
                    const term = filterText.toLowerCase();
                    data = data.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(term)));
                }

                // Headers
                document.getElementById('table-head').innerHTML = `<tr>${conf.headers.map(h => `<th class="px-6 py-3 font-semibold uppercase text-xs tracking-wider">${h}</th>`).join('')}</tr>`;
                
                // Body
                document.getElementById('table-body').innerHTML = data.map(row => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                        ${conf.fields.map(f => {
                            let val = typeof f === 'function' ? f(row) : row[f];
                            return `<td class="px-6 py-4 border-b border-slate-100 dark:border-slate-800">${val || '-'}</td>`;
                        }).join('')}
                    </tr>
                `).join('') || `<tr><td colspan="${conf.headers.length}" class="px-6 py-8 text-center text-slate-500">Nenhum registro encontrado.</td></tr>`;
            },

            renderFinanceiroSummary() {
                const contas = ['Dinheiro em Espécie', 'Banco Itaú', 'Banco Nubank', 'Banco Bradesco'];
                const summaryContainer = document.getElementById('financeiro-summary');
                
                let html = '';
                let saldoTotal = 0;

                // Movimentação de Entradas e Saídas (Últimos 30 Dias)
                const trintaDiasAtras = new Date();
                trintaDiasAtras.setDate(trintaDiasAtras.getDate() - 30);
                trintaDiasAtras.setHours(0, 0, 0, 0);

                const financas30Dias = State.data.financeiro.filter(row => {
                    if (!row.data) return false;
                    const dataLancamento = new Date(row.data + 'T00:00:00');
                    return dataLancamento >= trintaDiasAtras;
                });

                const entradas30d = financas30Dias.filter(f => f.tipo === 'receita').reduce((a, b) => a + b.valor, 0);
                const saidas30d = financas30Dias.filter(f => f.tipo === 'despesa').reduce((a, b) => a + b.valor, 0);

                html += `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-emerald-200 dark:border-emerald-800 shadow-sm flex flex-col justify-center">
                        <span class="text-[10px] text-slate-500 mb-1 font-bold uppercase tracking-wider"><i class="ph ph-arrow-up-right text-emerald-500 mr-1"></i> Entradas (30 Dias)</span>
                        <span class="text-xl font-bold text-emerald-600 dark:text-emerald-400">R$ ${entradas30d.toFixed(2)}</span>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-red-200 dark:border-red-800 shadow-sm flex flex-col justify-center">
                        <span class="text-[10px] text-slate-500 mb-1 font-bold uppercase tracking-wider"><i class="ph ph-arrow-down-left text-red-500 mr-1"></i> Saídas (30 Dias)</span>
                        <span class="text-xl font-bold text-red-600 dark:text-red-400">R$ ${saidas30d.toFixed(2)}</span>
                    </div>
                `;

                contas.forEach(conta => {
                    const receitas = State.data.financeiro.filter(f => f.conta === conta && f.tipo === 'receita' && f.status === 'pago').reduce((a, b) => a + b.valor, 0);
                    const despesas = State.data.financeiro.filter(f => f.conta === conta && f.tipo === 'despesa' && f.status === 'pago').reduce((a, b) => a + b.valor, 0);
                    const saldo = receitas - despesas;
                    saldoTotal += saldo;
                    
                    html += `
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col justify-center">
                            <span class="text-[10px] text-slate-500 mb-1 font-bold uppercase tracking-wider"><i class="ph ph-bank mr-1"></i> ${conta}</span>
                            <span class="text-xl font-bold ${saldo >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400'}">R$ ${saldo.toFixed(2)}</span>
                        </div>
                    `;
                });

                // Add Total Geral Card
                html += `
                    <div class="bg-brand-600 p-4 rounded-xl border border-brand-700 shadow-sm flex flex-col justify-center text-white">
                        <span class="text-[10px] text-brand-100 mb-1 font-bold uppercase tracking-wider"><i class="ph ph-wallet mr-1"></i> Saldo Total Global</span>
                        <span class="text-xl font-bold">R$ ${saldoTotal.toFixed(2)}</span>
                    </div>
                `;

                summaryContainer.innerHTML = html;
            },

            // ================= KANBAN & OS =================

            renderKanban() {
                const board = document.getElementById('kanban-board');
                
                // Força as classes corretas de flex-col para a nova disposição em linhas
                board.className = "flex-1 flex flex-col gap-6 overflow-y-auto pb-4 items-stretch px-1";

                board.innerHTML = KANBAN_STATUS.map(col => {
                    const cards = State.data.ordens.filter(o => o.status === col.id).map(os => {
                        const cliente = State.data.clientes.find(c => c.id === os.cliente_id)?.nome || 'Desconhecido';
                        const produto = State.data.produtos.find(p => p.id === os.produto_id)?.modelo || 'Produto Excluído';
                        return `
                            <div class="kanban-card flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm cursor-grab active:cursor-grabbing hover:border-brand-500 hover:shadow-md transition-all" draggable="true" ondragstart="App.dragStart(event, '${os.id}')" ondragend="App.dragEnd(event)">
                                <div class="flex items-center gap-3 sm:w-1/4">
                                    <span class="text-xs font-bold text-slate-500 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">${os.id}</span>
                                    <h4 class="font-bold text-sm truncate text-slate-800 dark:text-slate-100" title="${cliente}">${cliente}</h4>
                                </div>
                                <div class="flex items-center gap-2 sm:w-1/4">
                                    <div class="w-8 h-8 rounded bg-slate-50 dark:bg-slate-700 flex items-center justify-center text-slate-400"><i class="ph ph-t-shirt text-lg"></i></div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-slate-400">Produto</span>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">${os.quantidade}x ${produto}</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 sm:w-1/4">
                                    <div class="w-8 h-8 rounded bg-slate-50 dark:bg-slate-700 flex items-center justify-center text-slate-400"><i class="ph ph-calendar-blank text-lg"></i></div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-slate-400">Entrega</span>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">${new Date(os.data_entrega).toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:items-end sm:justify-center sm:w-1/4 pt-3 sm:pt-0 border-t sm:border-t-0 border-slate-100 dark:border-slate-700">
                                    <div class="flex justify-between items-center w-full sm:flex-col sm:items-end">
                                        <div class="flex flex-col sm:items-end">
                                            <span class="text-xs text-slate-400">Valor Total</span>
                                            <span class="font-bold text-brand-600 dark:text-brand-400 text-base">R$ ${os.valor_total.toFixed(2)}</span>
                                        </div>
                                        <div class="flex gap-2 mt-0 sm:mt-2">
                                            <button onclick="App.editarOS('${os.id}')" class="text-brand-600 dark:text-brand-400 hover:bg-brand-50 dark:hover:bg-slate-700 p-1.5 rounded transition" title="Editar"><i class="ph ph-pencil-simple text-lg"></i></button>
                                            <button onclick="App.excluirOS('${os.id}')" class="text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-slate-700 p-1.5 rounded transition" title="Excluir"><i class="ph ph-trash text-lg"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    return `
                        <div class="kanban-column w-full bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 sm:p-5 flex flex-col transition-colors border-2 border-dashed border-slate-200 dark:border-slate-700" ondragover="App.dragOver(event)" ondragleave="App.dragLeave(event)" ondrop="App.drop(event, '${col.id}')">
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 pb-3 border-b border-slate-200 dark:border-slate-700 gap-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-3 h-3 rounded-full ${col.color.split(' ')[0]} shadow-sm"></div>
                                    <h3 class="font-bold text-sm ${col.color.split(' ')[2] || 'text-slate-700 dark:text-slate-300'} uppercase tracking-wider">${col.label}</h3>
                                </div>
                                <span class="bg-white dark:bg-slate-800 text-xs font-bold px-3 py-1 rounded-full shadow-sm border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300">${State.data.ordens.filter(o => o.status === col.id).length} Pedido(s)</span>
                            </div>
                            <div class="flex-1 flex flex-col gap-3 min-h-[80px]">
                                ${cards || '<div class="w-full h-full flex items-center justify-center text-slate-400 text-sm italic py-6 border-2 border-transparent">Nenhum pedido nesta etapa. Arraste e solte um pedido aqui.</div>'}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            dragStart(e, id) { e.dataTransfer.setData('text/plain', id); e.target.classList.add('dragging'); },
            dragEnd(e) { e.target.classList.remove('dragging'); },
            dragOver(e) { e.preventDefault(); const col = e.target.closest('.kanban-column'); if(col) col.classList.add('drag-over'); },
            dragLeave(e) { const col = e.target.closest('.kanban-column'); if(col) col.classList.remove('drag-over'); },
            drop(e, newStatus) {
                e.preventDefault();
                document.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('drag-over'));
                const id = e.dataTransfer.getData('text/plain');
                const osIndex = State.data.ordens.findIndex(o => o.id === id);
                if(osIndex > -1 && State.data.ordens[osIndex].status !== newStatus) {
                    State.data.ordens[osIndex].status = newStatus;
                    this.saveDataLocally();
                    this.renderKanban();
                }
            },

            // ================= MODALS E FORMULÁRIOS =================

            handleAdicionar() {
                if (State.currentView === 'clientes') {
                    this.openModal('modal-cliente');
                } else if (State.currentView === 'produtos') {
                    this.openModal('modal-produto');
                } else if (State.currentView === 'financeiro') {
                    this.openModal('modal-financeiro');
                } else if (State.currentView === 'estoque') {
                    this.openModal('modal-estoque');
                }
            },

            openModal(modalId) {
                document.getElementById('modal-backdrop').classList.remove('hidden');
                // Trigger reflow
                void document.getElementById('modal-backdrop').offsetWidth;
                document.getElementById('modal-backdrop').classList.add('opacity-100');
                
                document.querySelectorAll('.modal-content').forEach(m => { m.classList.add('hidden'); m.classList.remove('scale-100'); });
                
                const modal = document.getElementById(modalId);
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('scale-100'), 10);

                if(modalId === 'modal-os') this.setupOSForm();
                if(modalId === 'modal-cliente') this.setupClienteForm();
                if(modalId === 'modal-produto') this.setupProdutoForm();
                if(modalId === 'modal-financeiro') this.setupFinanceiroForm();
                if(modalId === 'modal-estoque') this.setupEstoqueForm();
            },

            closeModal() {
                const backdrop = document.getElementById('modal-backdrop');
                backdrop.classList.remove('opacity-100');
                document.querySelectorAll('.modal-content').forEach(m => m.classList.remove('scale-100'));
                setTimeout(() => backdrop.classList.add('hidden'), 200);
            },

            showAlert(title, message, isError = false) {
                document.getElementById('alert-title').textContent = title;
                document.getElementById('alert-message').textContent = message;
                document.getElementById('alert-icon').innerHTML = isError ? '<i class="ph ph-warning-circle text-5xl text-red-500"></i>' : '<i class="ph ph-check-circle text-5xl text-emerald-500"></i>';
                this.openModal('modal-alert');
            },

            setupOSForm() {
                document.getElementById('os-id').value = '';
                // Populate selects
                document.getElementById('os-cliente').innerHTML = State.data.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                document.getElementById('os-produto').innerHTML = State.data.produtos.map(p => `<option value="${p.id}">${p.modelo} | ${p.tecido} | Tam: ${p.tamanho || '-'}</option>`).join('');
                document.getElementById('os-data').value = new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0];
                document.getElementById('os-preco-venda').value = '';
                this.calcularOS();
            },

            calcularOS() {
                const prodId = document.getElementById('os-produto').value;
                const qtd = parseInt(document.getElementById('os-quantidade').value) || 1;
                const frete = parseFloat(document.getElementById('os-frete').value) || 0;
                
                const produto = State.data.produtos.find(p => p.id === prodId);
                if(!produto) return;

                const calc = this.calcCustoProduto(produto);
                const precoManual = parseFloat(document.getElementById('os-preco-venda').value);
                const precoVendaUn = !isNaN(precoManual) && precoManual > 0 ? precoManual : calc.preco;

                const tecidoNecessario = (produto.consumo_metro || 0) * qtd;
                const custoTotal = (calc.custo * qtd);
                const valorVenda = (precoVendaUn * qtd) + frete;
                const lucro = valorVenda - custoTotal - frete; // Lucro operacional bruto

                document.getElementById('res-custo').textContent = `R$ ${custoTotal.toFixed(2)}`;
                document.getElementById('res-tecido').textContent = `${tecidoNecessario.toFixed(2)}m`;
                document.getElementById('res-unitario').textContent = `R$ ${precoVendaUn.toFixed(2)}`;
                document.getElementById('res-total').textContent = `R$ ${valorVenda.toFixed(2)}`;
                document.getElementById('res-lucro').textContent = `R$ ${lucro.toFixed(2)}`;

                // Verifica estoque visualmente
                const estoque = State.data.estoque.find(e => e.tecido === produto.tecido);
                const resTecidoEl = document.getElementById('res-tecido');
                if(estoque && estoque.metragem_atual < tecidoNecessario) {
                    resTecidoEl.classList.remove('text-amber-600');
                    resTecidoEl.classList.add('text-red-600', 'font-bold');
                    resTecidoEl.innerHTML += ' (Estoque Insuficiente!)';
                } else {
                    resTecidoEl.classList.remove('text-red-600');
                    resTecidoEl.classList.add('text-amber-600');
                }
            },

            salvarOS() {
                const idEdicao = document.getElementById('os-id').value;
                const prodId = document.getElementById('os-produto').value;
                const qtd = parseInt(document.getElementById('os-quantidade').value);
                const frete = parseFloat(document.getElementById('os-frete').value) || 0;
                const produto = State.data.produtos.find(p => p.id === prodId);
                
                // --- INÍCIO DA LÓGICA DE EDIÇÃO ---
                if (idEdicao) {
                    const calc = this.calcCustoProduto(produto);
                    const precoManual = parseFloat(document.getElementById('os-preco-venda').value);
                    const precoVendaUn = !isNaN(precoManual) && precoManual > 0 ? precoManual : calc.preco;

                    const valorVenda = (precoVendaUn * qtd) + frete;
                    const lucro = valorVenda - (calc.custo * qtd) - frete;

                    const index = State.data.ordens.findIndex(o => o.id === idEdicao);
                    if (index > -1) {
                        State.data.ordens[index] = {
                            ...State.data.ordens[index],
                            cliente_id: document.getElementById('os-cliente').value,
                            produto_id: prodId,
                            quantidade: qtd,
                            data_entrega: document.getElementById('os-data').value,
                            valor_total: valorVenda,
                            lucro: lucro
                        };
                    }
                    this.saveDataLocally();
                    this.closeModal();
                    this.showAlert('Sucesso', `Ordem ${idEdicao} atualizada com sucesso.`);
                    if(State.currentView === 'ordens') this.renderKanban();
                    return;
                }
                // --- FIM DA LÓGICA DE EDIÇÃO ---

                // --- LÓGICA DE CRIAÇÃO ORIGINAL INTACTA ---
                const tecidoNecessario = (produto.consumo_metro || 0) * qtd;
                const estoqueIndex = State.data.estoque.findIndex(e => e.tecido === produto.tecido);

                if(estoqueIndex === -1 || State.data.estoque[estoqueIndex].metragem_atual < tecidoNecessario) {
                    this.showAlert('Atenção', 'Estoque de tecido insuficiente para esta ordem.', true);
                    return;
                }

                // Baixa no estoque
                State.data.estoque[estoqueIndex].metragem_atual -= tecidoNecessario;

                // Calcula valores
                const calc = this.calcCustoProduto(produto);
                const precoManual = parseFloat(document.getElementById('os-preco-venda').value);
                const precoVendaUn = !isNaN(precoManual) && precoManual > 0 ? precoManual : calc.preco;

                const valorVenda = (precoVendaUn * qtd) + frete;
                const lucro = valorVenda - (calc.custo * qtd) - frete;

                // Cria OS
                const novaOS = {
                    id: `OS-${1000 + State.data.ordens.length + 1}`,
                    cliente_id: document.getElementById('os-cliente').value,
                    produto_id: prodId,
                    quantidade: qtd,
                    status: 'orcamento',
                    data_inicio: new Date().toISOString().split('T')[0],
                    data_entrega: document.getElementById('os-data').value,
                    valor_total: valorVenda,
                    lucro: lucro
                };

                State.data.ordens.push(novaOS);
                this.saveDataLocally();
                
                this.closeModal();
                this.showAlert('Sucesso', `Ordem ${novaOS.id} gerada e ${tecidoNecessario.toFixed(2)}m de tecido baixados do estoque.`);
                if(State.currentView === 'ordens') this.renderKanban();
            },

            editarOS(id) {
                const os = State.data.ordens.find(o => o.id === id);
                if (!os) return;

                this.openModal('modal-os');

                // Sobrescreve após o reset do openModal
                document.getElementById('os-id').value = os.id;
                document.getElementById('os-cliente').value = os.cliente_id || '';
                document.getElementById('os-produto').value = os.produto_id || '';
                document.getElementById('os-quantidade').value = os.quantidade || 1;
                document.getElementById('os-data').value = os.data_entrega || '';

                this.calcularOS();
            },

            excluirOS(id) {
                State.data.ordens = State.data.ordens.filter(o => o.id !== id);
                this.saveDataLocally();
                if (State.currentView === 'ordens') this.renderKanban();
                this.showAlert('Sucesso', 'Ordem de serviço excluída com sucesso.');
            },

            setupClienteForm() {
                // Limpa os campos do formulário de cliente
                document.getElementById('cli-id').value = '';
                document.getElementById('cli-nome').value = '';
                document.getElementById('cli-cpf-cnpj').value = '';
                document.getElementById('cli-telefone').value = '';
                document.getElementById('cli-email').value = '';
                document.getElementById('cli-endereco').value = '';
                document.getElementById('cli-cidade').value = '';
                document.getElementById('cli-estado').value = '';
            },

            salvarCliente() {
                const nome = document.getElementById('cli-nome').value.trim();
                const idEdicao = document.getElementById('cli-id').value;
                
                if (!nome) {
                    this.showAlert('Atenção', 'O nome do cliente é obrigatório.', true);
                    return;
                }

                const clienteData = {
                    nome: nome,
                    cpf_cnpj: document.getElementById('cli-cpf-cnpj').value.trim(),
                    telefone: document.getElementById('cli-telefone').value.trim(),
                    email: document.getElementById('cli-email').value.trim(),
                    endereco: document.getElementById('cli-endereco').value.trim(),
                    cidade: document.getElementById('cli-cidade').value.trim(),
                    estado: document.getElementById('cli-estado').value.trim().toUpperCase()
                };

                if (idEdicao) {
                    // Edição
                    const index = State.data.clientes.findIndex(c => c.id === idEdicao);
                    if (index > -1) {
                        State.data.clientes[index] = { id: idEdicao, ...clienteData };
                    }
                    this.showAlert('Sucesso', `Cliente ${nome} atualizado com sucesso.`);
                } else {
                    // Criação (mantém a lógica original intacta)
                    const novoId = `C${String(State.data.clientes.length + 1).padStart(3, '0')}`;
                    const novoCliente = { id: novoId, ...clienteData };
                    State.data.clientes.push(novoCliente);
                    this.showAlert('Sucesso', `Cliente ${nome} cadastrado com sucesso.`);
                }
                
                // Salva no LocalStorage/API
                this.saveDataLocally();
                
                // Fecha o modal e atualiza a interface
                this.closeModal();
                
                // Atualiza a tabela se o usuário ainda estiver na tela de clientes
                if (State.currentView === 'clientes') {
                    this.renderCurrentTable();
                }
            },

            editarCliente(id) {
                const cliente = State.data.clientes.find(c => c.id === id);
                if (!cliente) return;
                
                // Abre o modal
                this.openModal('modal-cliente');
                
                // Preenche com os dados existentes
                document.getElementById('cli-id').value = cliente.id;
                document.getElementById('cli-nome').value = cliente.nome || '';
                document.getElementById('cli-cpf-cnpj').value = cliente.cpf_cnpj || '';
                document.getElementById('cli-telefone').value = cliente.telefone || '';
                document.getElementById('cli-email').value = cliente.email || '';
                document.getElementById('cli-endereco').value = cliente.endereco || '';
                document.getElementById('cli-cidade').value = cliente.cidade || '';
                document.getElementById('cli-estado').value = cliente.estado || '';
            },

            excluirCliente(id) {
                State.data.clientes = State.data.clientes.filter(c => c.id !== id);
                this.saveDataLocally();
                if (State.currentView === 'clientes') this.renderCurrentTable();
                this.showAlert('Sucesso', 'Cliente excluído com sucesso.');
            },

            setupProdutoForm() {
                document.getElementById('prod-id').value = '';
                document.getElementById('prod-modelo').value = '';
                document.getElementById('prod-tecido').value = '';
                document.getElementById('prod-tamanho').value = '';
                document.getElementById('prod-altura').value = '';
                document.getElementById('prod-largura').value = '';
                document.getElementById('prod-consumo').value = '';
                document.getElementById('prod-custo-metro').value = '';
                document.getElementById('prod-custo-estampa').value = '';
                document.getElementById('prod-mao-obra').value = '';
            },

            salvarProduto() {
                const modelo = document.getElementById('prod-modelo').value.trim();
                const tecido = document.getElementById('prod-tecido').value.trim();
                const idEdicao = document.getElementById('prod-id').value;
                
                if (!modelo || !tecido) {
                    this.showAlert('Atenção', 'Estilo/Modelo e Tipo de Malha são obrigatórios.', true);
                    return;
                }

                const produtoData = {
                    tipo: 'Confecção', // Fixo para compatibilidade
                    modelo: modelo,
                    tecido: tecido,
                    tamanho: document.getElementById('prod-tamanho').value.trim(),
                    altura: parseFloat(document.getElementById('prod-altura').value) || 0,
                    largura: parseFloat(document.getElementById('prod-largura').value) || 0,
                    consumo_metro: parseFloat(document.getElementById('prod-consumo').value) || 0,
                    custo_metro: parseFloat(document.getElementById('prod-custo-metro').value) || 0,
                    custo_estampa: parseFloat(document.getElementById('prod-custo-estampa').value) || 0,
                    mao_obra: parseFloat(document.getElementById('prod-mao-obra').value) || 0,
                    margem: 0 // Margem zerada pois preço é informado na OS
                };

                if (idEdicao) {
                    const index = State.data.produtos.findIndex(p => p.id === idEdicao);
                    if (index > -1) State.data.produtos[index] = { id: idEdicao, ...produtoData };
                    this.showAlert('Sucesso', `Produto atualizado com sucesso.`);
                } else {
                    const novoId = `P${String(State.data.produtos.length + 1).padStart(3, '0')}`;
                    State.data.produtos.push({ id: novoId, ...produtoData });
                    this.showAlert('Sucesso', `Produto cadastrado com sucesso.`);
                }
                
                this.saveDataLocally();
                this.closeModal();
                if (State.currentView === 'produtos') this.renderCurrentTable();
            },

            editarProduto(id) {
                const produto = State.data.produtos.find(p => p.id === id);
                if (!produto) return;
                
                this.openModal('modal-produto');
                
                document.getElementById('prod-id').value = produto.id;
                document.getElementById('prod-modelo').value = produto.modelo || '';
                document.getElementById('prod-tecido').value = produto.tecido || '';
                document.getElementById('prod-tamanho').value = produto.tamanho || '';
                document.getElementById('prod-altura').value = produto.altura || '';
                document.getElementById('prod-largura').value = produto.largura || '';
                document.getElementById('prod-consumo').value = produto.consumo_metro || '';
                document.getElementById('prod-custo-metro').value = produto.custo_metro || '';
                document.getElementById('prod-custo-estampa').value = produto.custo_estampa || '';
                document.getElementById('prod-mao-obra').value = produto.mao_obra || '';
            },

            excluirProduto(id) {
                State.data.produtos = State.data.produtos.filter(p => p.id !== id);
                this.saveDataLocally();
                if (State.currentView === 'produtos') this.renderCurrentTable();
                this.showAlert('Sucesso', 'Produto excluído com sucesso.');
            },

            setupFinanceiroForm() {
                document.getElementById('fin-id').value = '';
                document.getElementById('fin-tipo').value = 'receita';
                document.getElementById('fin-conta').value = 'Dinheiro em Espécie';
                document.getElementById('fin-descricao').value = '';
                document.getElementById('fin-categoria').value = 'Vendas';
                document.getElementById('fin-valor').value = '';
                document.getElementById('fin-data').value = new Date().toISOString().split('T')[0];
                document.getElementById('fin-status').value = 'pago';
                
                // Habilita e reseta o campo de parcelas para novos lançamentos
                const parcelasInput = document.getElementById('fin-parcelas');
                if (parcelasInput) {
                    parcelasInput.value = '1';
                    parcelasInput.disabled = false;
                }
            },

            salvarFinanceiro() {
                const tipo = document.getElementById('fin-tipo').value;
                const conta = document.getElementById('fin-conta').value;
                const descricao = document.getElementById('fin-descricao').value.trim();
                const categoria = document.getElementById('fin-categoria').value;
                const valor = parseFloat(document.getElementById('fin-valor').value) || 0;
                const data = document.getElementById('fin-data').value;
                const status = document.getElementById('fin-status').value;
                const idEdicao = document.getElementById('fin-id').value;
                const parcelas = parseInt(document.getElementById('fin-parcelas').value) || 1;
                
                if (!descricao || valor <= 0 || !data) {
                    this.showAlert('Atenção', 'Descrição, Valor e Data são obrigatórios.', true);
                    return;
                }

                if (idEdicao) {
                    // Lógica original de Edição Individual preservada
                    const financeiroData = {
                        tipo: tipo,
                        conta: conta,
                        descricao: descricao,
                        categoria: categoria,
                        valor: valor,
                        data: data,
                        status: status
                    };
                    const index = State.data.financeiro.findIndex(f => f.id === idEdicao);
                    if (index > -1) State.data.financeiro[index] = { id: idEdicao, ...financeiroData };
                    this.showAlert('Sucesso', `Lançamento atualizado com sucesso.`);
                } else {
                    // Lógica de Criação (Com suporte a múltiplas parcelas)
                    if (parcelas > 1) {
                        const valorParcela = valor / parcelas;
                        
                        for (let i = 1; i <= parcelas; i++) {
                            let d = new Date(data + 'T12:00:00'); // T12:00:00 evita bugs de fuso horário
                            d.setMonth(d.getMonth() + (i - 1));
                            let dataFormatada = d.toISOString().split('T')[0];

                            const novoId = `F${String(State.data.financeiro.length + 1).padStart(3, '0')}`;
                            State.data.financeiro.push({
                                id: novoId,
                                tipo: tipo,
                                conta: conta,
                                descricao: `${descricao} (${i}/${parcelas})`,
                                categoria: categoria,
                                valor: valorParcela,
                                data: dataFormatada,
                                status: i === 1 ? status : 'pendente'
                            });
                        }
                        this.showAlert('Sucesso', `Lançamento de ${parcelas} parcelas registrado.`);
                    } else {
                        // Lógica original intacta para lançamento único
                        const financeiroData = {
                            tipo: tipo,
                            conta: conta,
                            descricao: descricao,
                            categoria: categoria,
                            valor: valor,
                            data: data,
                            status: status
                        };
                        const novoId = `F${String(State.data.financeiro.length + 1).padStart(3, '0')}`;
                        State.data.financeiro.push({ id: novoId, ...financeiroData });
                        this.showAlert('Sucesso', `Lançamento registrado com sucesso.`);
                    }
                }
                
                this.saveDataLocally();
                this.closeModal();
                if (State.currentView === 'financeiro') this.renderCurrentTable();
            },

            editarFinanceiro(id) {
                const lancamento = State.data.financeiro.find(f => f.id === id);
                if (!lancamento) return;
                
                this.openModal('modal-financeiro');
                
                document.getElementById('fin-id').value = lancamento.id;
                document.getElementById('fin-tipo').value = lancamento.tipo || 'receita';
                document.getElementById('fin-conta').value = lancamento.conta || 'Dinheiro em Espécie';
                document.getElementById('fin-descricao').value = lancamento.descricao || '';
                document.getElementById('fin-categoria').value = lancamento.categoria || 'Outros';
                document.getElementById('fin-valor').value = lancamento.valor || '';
                document.getElementById('fin-data').value = lancamento.data || '';
                document.getElementById('fin-status').value = lancamento.status || 'pago';

                // Desabilita as parcelas na edição para proteger as regras de negócio
                const parcelasInput = document.getElementById('fin-parcelas');
                if (parcelasInput) {
                    parcelasInput.value = '1';
                    parcelasInput.disabled = true;
                }
            },

            excluirFinanceiro(id) {
                State.data.financeiro = State.data.financeiro.filter(f => f.id !== id);
                this.saveDataLocally();
                if (State.currentView === 'financeiro') this.renderCurrentTable();
                this.showAlert('Sucesso', 'Lançamento excluído com sucesso.');
            },

            setupEstoqueForm() {
                document.getElementById('est-id').value = '';
                document.getElementById('est-tecido').value = '';
                document.getElementById('est-metragem').value = '';
                document.getElementById('est-custo').value = '';
                document.getElementById('est-minimo').value = '';
            },

            salvarEstoque() {
                const tecido = document.getElementById('est-tecido').value.trim();
                const metragem_atual = parseFloat(document.getElementById('est-metragem').value) || 0;
                const custo_medio = parseFloat(document.getElementById('est-custo').value) || 0;
                const estoque_minimo = parseFloat(document.getElementById('est-minimo').value) || 0;
                const idEdicao = document.getElementById('est-id').value;
                
                if (!tecido) {
                    this.showAlert('Atenção', 'O nome do material/tecido é obrigatório.', true);
                    return;
                }

                const estoqueData = {
                    tecido: tecido,
                    metragem_atual: metragem_atual,
                    custo_medio: custo_medio,
                    estoque_minimo: estoque_minimo
                };

                if (idEdicao) {
                    const index = State.data.estoque.findIndex(e => e.id === idEdicao);
                    if (index > -1) State.data.estoque[index] = { id: idEdicao, ...estoqueData };
                    this.showAlert('Sucesso', `Material atualizado com sucesso.`);
                } else {
                    const novoId = `E${String(State.data.estoque.length + 1).padStart(3, '0')}`;
                    State.data.estoque.push({ id: novoId, ...estoqueData });
                    this.showAlert('Sucesso', `Material cadastrado com sucesso.`);
                }
                
                this.saveDataLocally();
                this.closeModal();
                if (State.currentView === 'estoque') this.renderCurrentTable();
            },

            editarEstoque(id) {
                const material = State.data.estoque.find(e => e.id === id);
                if (!material) return;
                
                this.openModal('modal-estoque');
                
                document.getElementById('est-id').value = material.id;
                document.getElementById('est-tecido').value = material.tecido || '';
                document.getElementById('est-metragem').value = material.metragem_atual || 0;
                document.getElementById('est-custo').value = material.custo_medio || 0;
                document.getElementById('est-minimo').value = material.estoque_minimo || 0;
            },

            excluirEstoque(id) {
                State.data.estoque = State.data.estoque.filter(e => e.id !== id);
                this.saveDataLocally();
                if (State.currentView === 'estoque') this.renderCurrentTable();
                this.showAlert('Sucesso', 'Material excluído com sucesso.');
            },

            saveDataLocally() {
                localStorage.setItem('erp_data', JSON.stringify(State.data));
                
                // Envia as alterações para a planilha em tempo real
                if(CONFIG.API_URL) {
                    console.log('Enviando dados para o Google Sheets via API...');
                    fetch(CONFIG.API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'syncData', payload: State.data })
                    }).catch(error => console.error('Erro na sincronização:', error));
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
